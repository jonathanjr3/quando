<html id="html">

<head> 
    <title>{{ title }}</title>
    <meta charset="UTF-8">
    <script>
        // Try to get token from URL first, then from localStorage
        const urlParams = new URLSearchParams(window.location.search);
        let token = urlParams.get('token');
        
        if (token) {
            localStorage.setItem('quando-session-token', token);
            // Don't clean the URL immediately - wait for all resources to load
            // so the referer header will contain the token for resource requests
            window.addEventListener('load', function() {
                // Clean the URL after all resources have loaded
                window.history.replaceState({}, document.title, window.location.pathname);
            });
        } else {
            token = localStorage.getItem('quando-session-token');
        }

        // Check authentication status - either pairing token or admin session
        async function checkAuthentication() {
            console.log('Checking authentication...');
            console.log('Token from localStorage:', token);
            
            // First check if we have a valid pairing token
            if (token && token.startsWith('TOKEN_')) {
                console.log('Valid pairing token found');
                return true;
            }
            
            // If no pairing token, check if user is authenticated admin
            console.log('No pairing token, checking admin authentication...');
            try {
                const authCheckUrl = window.location.protocol + '//' + window.location.host + '/api/auth-check';
                const response = await fetch(authCheckUrl, {
                    credentials: 'include' // Include session cookies
                });
                console.log('Auth check response status:', response.status);
                if (response.ok) {
                    const data = await response.json();
                    console.log('Auth check response data:', data);
                    if (data.authenticated) {
                        console.log('Admin authentication confirmed');
                        return true;
                    }
                }
            } catch (error) {
                console.log('Auth check failed:', error);
            }
            
            console.log('Authentication failed');
            return false;
        }

        // Check authentication and redirect if necessary
        checkAuthentication().then(isAuthenticated => {
            if (!isAuthenticated) {
                // Create safe DOM elements to prevent XSS
                const container = document.createElement('div');
                container.style.cssText = 'padding: 20px; font-family: Arial;';
                
                const title = document.createElement('h2');
                title.textContent = 'Authentication Debug Info';
                
                const tokenInfo = document.createElement('p');
                const tokenLabel = document.createElement('strong');
                tokenLabel.textContent = 'Token from localStorage: ';
                tokenInfo.appendChild(tokenLabel);
                tokenInfo.appendChild(document.createTextNode(token || 'null'));
                
                const tokenValid = document.createElement('p');
                const validLabel = document.createElement('strong');
                validLabel.textContent = 'Token valid: ';
                tokenValid.appendChild(validLabel);
                tokenValid.appendChild(document.createTextNode(token && token.startsWith('TOKEN_') ? 'Yes' : 'No'));
                
                const authStatus = document.createElement('p');
                authStatus.id = 'auth-status';
                authStatus.textContent = 'Checking admin authentication...';
                
                const consoleInfo = document.createElement('p');
                const consoleLabel = document.createElement('strong');
                consoleLabel.textContent = 'Console logs: ';
                consoleInfo.appendChild(consoleLabel);
                consoleInfo.appendChild(document.createTextNode('Check browser console (F12) for detailed logs'));
                
                const button = document.createElement('button');
                button.textContent = 'Continue to Goodbye Page';
                button.onclick = function() { window.location.href = '/goodbye'; };
                
                container.appendChild(title);
                container.appendChild(tokenInfo);
                container.appendChild(tokenValid);
                container.appendChild(authStatus);
                container.appendChild(consoleInfo);
                container.appendChild(button);
                
                document.body.innerHTML = '';
                document.body.appendChild(container);
                
                // Test the auth endpoint again and show result - use absolute URL for cross-origin compatibility
                const authCheckUrl = window.location.protocol + '//' + window.location.host + '/api/auth-check';
                fetch(authCheckUrl, { credentials: 'include' })
                    .then(response => response.json())
                    .then(data => {
                        const statusElement = document.getElementById('auth-status');
                        const statusLabel = document.createElement('strong');
                        statusLabel.textContent = 'Admin authentication result: ';
                        statusElement.innerHTML = '';
                        statusElement.appendChild(statusLabel);
                        statusElement.appendChild(document.createTextNode(data.authenticated ? 'AUTHENTICATED' : 'NOT AUTHENTICATED'));
                    })
                    .catch(error => {
                        const statusElement = document.getElementById('auth-status');
                        const statusLabel = document.createElement('strong');
                        statusLabel.textContent = 'Admin authentication error: ';
                        statusElement.innerHTML = '';
                        statusElement.appendChild(statusLabel);
                        statusElement.appendChild(document.createTextNode(error.message));
                    });
            }
        });
    </script>
    <link href="/client/client.css" rel="stylesheet" type="text/css" />
    <script type="module" src="/client/client.js"></script>
    <script type="module" src="/client/modules/display.js"></script>
    <script type="module" src="/client/modules/destructor.js"></script>
    <script type="module" src="/common/text.js"></script>
    <script defer src="/client/modules/style.js"></script>
    <script defer src="/client/modules/image.js"></script>
    <script type="module" src="/client/modules/time.js"></script>
    <script type="module" src="/client/modules/pick.js"></script>
    <script type="module" src="/client/modules/misc.js"></script>
    <script defer src="/client/extlib/leap-1.1.0.js"></script>
    <script defer src="/client/modules/leap.js"></script>
    <script type="module" src="/client/modules/ubit.js"></script>
    <script type="module" src="/client/modules/system.js"></script>
    <script type="module" defer src="/client/modules/message.js"></script>
    <script type="module" src="/client/modules/rpico.js"></script>
    <script defer src="/client/modules/speech.js"></script>
    <!-- <script defer src="/client/modules/watson.js"></script> -->
    <script defer src="/client/extlib/three.js"></script>
    <script defer src="/client/extlib/gltfloader.js"></script>
    <script defer src="/client/modules/object3d.js"></script>
    <!-- <script defer src="/client/extlib/objloader.js"></script> -->
    <!-- <script defer src="/client/extlib/mtlloader.js"></script> -->
    <script defer src="/client/extlib/aframe.min.js"></script>
    <script defer src="/client/extlib/aframe-ar.js"></script>
    <script type="module" src="/client/modules/ar.js"></script>
    <script defer src="/client/extlib/qimessaging.js"></script>
    <script type="module" defer src="/client/modules/media.js"></script>
    <script type="module" src="/client/modules/robot.js"></script>    
    <!-- TODO restore if EEG headset available that works
        <script defer src="/client/extlib/cortex.js"></script>
        <script defer src="/client/extlib/ml.js"></script>
        <script type="module" src="/client/modules/eeg.js"></script> -->
    <script type="module" src="/client/modules/key_control.js"></script>
    <script type="module" src="/client/modules/key.js"></script>
    <script type="module" src="/client/modules/mouse.js"></script>
    <script type="module" src="/client/modules/mouse_control.js"></script>
    <script type="module" src="/client/modules/gamepad.js"></script>
    <script type="module" src="/client/modules/gamepad_server.js"></script>
    <link rel="icon" href="/favicon.ico">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
</head>

<body id="body" onload="quando.startDisplay();">
    <div id="container">
        <div id='quando_title'></div>
        <div id="quando_3d"></div>
        <div id="quando_AR"></div>
        <svg id="quando_image_parent" viewBox="0 0 1 1">
            <img id="quando_image"/>
            <img id="quando_image_display"/>
        </svg>
        <video id="quando_video"></video>
        <audio id="quando_audio"></audio>
        <div id='quando_buttons'></div>
        <div id='quando_labels'></div>
        <div id='quando_text'></div>
        <div id="cursor"></div>
    </div>
    <!-- DO NOT DELETE THE NEXT LINE - Quando relies on it... -->
    <script id="quando_script" src="/scripts/{{ title }}.js"></script>
</body>

</html>