<html>
<head>
    <title>Setup Client</title>
    <meta charset="UTF-8">
    <script type="text/javascript">
        function onload() {
            // Try to get token from URL first, then from localStorage
            const urlParams = new URLSearchParams(window.location.search);
            let token = urlParams.get('token');
            
            if (token) {
                localStorage.setItem('quando-session-token', token);
                // Clean the URL
                window.history.replaceState({}, document.title, "/client/setup.html");
            } else {
                token = localStorage.getItem('quando-session-token');
            }

            if (!token || !token.startsWith('TOKEN_')) {
                document.body.innerHTML = '<h1>Unauthorized</h1><p>No valid session found. Please <a href="/join">pair your device</a> first.</p>';
                return;
            }

            fetch(`/scripts?token=${encodeURIComponent(token)}`).then((res) => res.json()).then(
                (response) => {
                    if (response.success) {
                        var list = document.getElementById("list_js");
                        list.innerHTML = '';
                        var result = '';
                        for(var i=0; i<response.files.length; i++) {
                            result += '<button onclick="setJs(\'' + response.files[i] + '\');">' + response.files[i] + '</button><br/>';
                        }
                        list.innerHTML = result;
                    } else {
                        document.getElementById("list_js").innerHTML = 'Error loading scripts: ' + (response.message || 'Unknown error');
                    }
                }
            ).catch(error => {
                console.error('Error fetching scripts:', error);
                document.getElementById("list_js").innerHTML = 'Error loading scripts. Please check your connection.';
            });
        }
        function setJs(name) {
            localStorage.setItem('client_js', name);
            const token = localStorage.getItem('quando-session-token');
            document.location = `/client/?token=${encodeURIComponent(token)}`;
        }
        
        function disconnect() {
            if (confirm('Are you sure you want to disconnect? You will need to pair again.')) {
                const token = localStorage.getItem('quando-session-token');
                if (token) {
                    // First try the proper disconnect endpoint
                    fetch('/disconnect', {
                        method: 'POST',
                        headers: {
                            'Authorization': token,
                            'Content-Type': 'application/x-www-form-urlencoded'
                        }
                    }).then(response => {
                        if (response.ok) {
                            console.log('Successfully disconnected via API');
                        } else {
                            console.warn('API disconnect failed, trying WebSocket method');
                            
                            // Fallback: try WebSocket disconnect
                            const parts = token.split('_');
                            if (parts.length >= 3) {
                                const sessionId = parts[1];
                                
                                const ws = new WebSocket(`ws://${window.location.host}/ws/handshake`);
                                ws.onopen = () => {
                                    ws.send(JSON.stringify({ 
                                        type: 'register_client', 
                                        sessionId: sessionId 
                                    }));
                                    ws.send(JSON.stringify({ 
                                        type: 'disconnect' 
                                    }));
                                    ws.close();
                                };
                            }
                        }
                        
                        // Always clean up and redirect regardless of API success
                        localStorage.removeItem('quando-session-token');
                        localStorage.removeItem('client_js');
                        window.location.href = '/goodbye';
                        
                    }).catch(error => {
                        console.error('Error disconnecting via API:', error);
                        
                        // Fallback: try WebSocket method on error
                        const parts = token.split('_');
                        if (parts.length >= 3) {
                            const sessionId = parts[1];
                            
                            const ws = new WebSocket(`ws://${window.location.host}/ws/handshake`);
                            ws.onopen = () => {
                                ws.send(JSON.stringify({ 
                                    type: 'register_client', 
                                    sessionId: sessionId 
                                }));
                                ws.send(JSON.stringify({ 
                                    type: 'disconnect' 
                                }));
                                ws.close();
                            };
                        }
                        
                        // Clean up and redirect even on error
                        localStorage.removeItem('quando-session-token');
                        localStorage.removeItem('client_js');
                        window.location.href = '/goodbye';
                    });
                } else {
                    // No token, just redirect
                    window.location.href = '/goodbye';
                }
            }
        }
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="setup.css">
</head>

<body onload="onload();">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>Choose script to execute by default:</div>
        <button onclick="disconnect()" style="background: #ff4444; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Disconnect</button>
    </div>
    <div id='list_js'>Loading...</div>
</body>

</html>