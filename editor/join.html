<!DOCTYPE html>
<html>
<head>
    <title>Quando - Join Session</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            text-align: center; 
            padding-top: 5vh; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; 
            margin: 0;
            min-height: 100vh;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 2em;
        }
        
        h1 { 
            font-weight: 300; 
            font-size: 2.5em;
            margin-bottom: 0.5em;
        }
        
        .subtitle {
            font-size: 1.2em;
            margin-bottom: 2em;
            opacity: 0.9;
        }
        
        #qr-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            display: inline-block;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            margin-bottom: 2em;
        }
        
        #sas-container { 
            font-size: 4em; 
            font-weight: bold; 
            letter-spacing: 0.2em; 
            margin-top: 30px; 
            margin-bottom: 40px;
            height: auto;
            min-height: 1.2em;
            color: #f1c40f;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            font-family: 'Courier New', monospace;
            clear: both;
        }

        .qr-url {
            background: rgba(255,255,255,0.95);
            color: #333;
            padding: 10px 12px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            word-break: break-all;
            display: inline-block;
            margin-top: 10px;
            user-select: all;
        }
        
        .status {
            font-size: 1.1em;
            margin-top: 2em;
            margin-bottom: 1.5em;
            opacity: 0.8;
            min-height: 2em;
            clear: both;
        }
        
        .instructions {
            background: rgba(255,255,255,0.1);
            padding: 1.5em;
            border-radius: 10px;
            margin-top: 2em;
            backdrop-filter: blur(10px);
        }
        
        .step {
            margin: 0.5em 0;
            font-size: 1.1em;
        }
        
        @media (max-width: 768px) {
            h1 { font-size: 2em; }
            #sas-container { font-size: 3em; }
            .container { padding: 1em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Secure Device Pairing</h1>
        <div class="subtitle">Establish a cryptographically secure connection to this Quando session</div>
        
        <div id="qr-container">
            <div id="qrcode"></div>
        </div>
    <div id="qr-url" class="qr-url" title="Join URL"></div>
        
        <div id="sas-container">Waiting for secure connection...</div>
        <div class="status" id="status">Ready for secure pairing</div>
        
        <div class="instructions">
            <div class="step">1️⃣ Scan the QR code with your mobile device</div>
            <div class="step">2️⃣ Tap "Start Secure Pairing" on your device</div>
            <div class="step">3️⃣ Verify the 6-digit security code matches on both devices</div>
        </div>
    </div>

    <script src="/js/qrcode.min.js"></script>
    <script>
        let sessionId = generateSessionId();
        const qrContainer = document.getElementById('qrcode');
        const qrContainerWrapper = document.getElementById('qr-container');
        const sasContainer = document.getElementById('sas-container');
        const statusElement = document.getElementById('status');
        let currentWs = null;
        let qrRefreshTimer = null;
        let qrRefreshInterval = 5 * 60 * 1000; // Default 5 minutes in milliseconds
        
        function generateSessionId() {
            return Math.random().toString(36).substring(2) + Date.now().toString(36);
        }

        async function loadQRRefreshInterval() {
            try {
                const response = await fetch('/api/pairing-config');
                const result = await response.json();
                
                if (response.ok && result.success) {
                    qrRefreshInterval = result.config.qr_refresh_interval_minutes * 60 * 1000; // Convert to milliseconds
                    console.log(`QR refresh interval set to ${result.config.qr_refresh_interval_minutes} minutes`);
                }
            } catch (error) {
                console.error('Failed to load QR refresh interval:', error);
                // Keep default interval on error
            }
        }

        function startQRRefreshTimer() {
            // Clear any existing timer
            if (qrRefreshTimer) {
                clearTimeout(qrRefreshTimer);
            }
            
            // Set timer to refresh QR code
            qrRefreshTimer = setTimeout(() => {
                console.log('QR refresh timer triggered - restarting pairing');
                restartPairing();
            }, qrRefreshInterval);
        }

        function stopQRRefreshTimer() {
            if (qrRefreshTimer) {
                clearTimeout(qrRefreshTimer);
                qrRefreshTimer = null;
            }
        }

        function restartPairing() {
            // Stop QR refresh timer
            stopQRRefreshTimer();
            
            // Close existing WebSocket if any
            if (currentWs) {
                currentWs.close();
                currentWs = null;
            }
            
            // Generate new session ID
            sessionId = generateSessionId();
            console.log('Restarting pairing with new session:', sessionId);
            
            // Reset UI
            sasContainer.textContent = "Waiting for connection...";
            statusElement.textContent = 'Ready to pair';
            
            // Regenerate QR code and reconnect
            generateQR();
            connectWebSocket();
            
            // Start QR refresh timer
            startQRRefreshTimer();
        }

        function generateQR() {
            // Detect if we're accessing via remote IP and use that for QR code
            const currentHost = window.location.host;
            let qrHost = currentHost;
            
            // If we're on localhost/127.0.0.1, try to get the remote IP
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                // For local development, we'll fetch the remote IP from the server
                fetch('/ip')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.remote && data.ip) {
                            qrHost = `${data.ip}:${window.location.port || '8080'}`;
                            generateQRWithHost(qrHost);
                        } else {
                            generateQRWithHost(currentHost);
                        }
                    })
                    .catch(() => {
                        generateQRWithHost(currentHost);
                    });
            } else {
                // Already on remote IP, use current host
                generateQRWithHost(currentHost);
            }
        }

        function generateQRWithHost(host) {
            try {
                qrContainer.innerHTML = ''; // Clear previous QR code
                
                // Generate QR code with URL (not JSON)
                const joinUrl = `${window.location.protocol}//${host}/pair/${sessionId}`;
                console.log('Generating QR code for URL:', joinUrl);
                const qrUrlEl = document.getElementById('qr-url');
                if (qrUrlEl) { qrUrlEl.textContent = joinUrl; }
                
                const qr = new QRCode(qrContainer, {
                    text: joinUrl,
                    width: 256,
                    height: 256,
                    colorDark: '#000000',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.M
                });
                
                statusElement.textContent = 'QR code ready - scan with your device';
            } catch (error) {
                console.error('Failed to generate QR code:', error);
                qrContainer.innerHTML = '<p style="color: black;">QR Code generation failed</p>';
                statusElement.textContent = 'QR code generation failed';
            }
        }

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/handshake`;
            console.log('Connecting to WebSocket:', wsUrl);
            
            currentWs = new WebSocket(wsUrl);

            currentWs.onopen = () => {
                console.log('WebSocket connected');
                sasContainer.textContent = "Waiting for user...";
                statusElement.textContent = 'Connected - waiting for mobile device';
                
                currentWs.send(JSON.stringify({ 
                    type: 'register_display', 
                    sessionId: sessionId 
                }));
            };

            currentWs.onmessage = (event) => {
                console.log('WebSocket message received:', event.data);
                try {
                    const data = JSON.parse(event.data);
                    
                    switch(data.type) {
                        case 'show_sas':
                            sasContainer.textContent = data.sas;
                            statusElement.textContent = 'Verify this security code matches on your device';
                            break;
                        case 'pairing_complete':
                            sasContainer.textContent = "🔐 SECURE CONNECTION ESTABLISHED!";
                            statusElement.textContent = 'Device successfully connected with cryptographic security';
                            // Hide QR code when device is paired
                            qrContainerWrapper.style.display = 'none';
                            const urlEl1 = document.getElementById('qr-url');
                            if (urlEl1) { urlEl1.style.display = 'none'; }
                            break;
                        case 'client_disconnected':
                            sasContainer.textContent = "Ready for secure pairing";
                            statusElement.textContent = 'Device disconnected - ready for new secure connection';
                            // Show QR code again when device disconnects
                            qrContainerWrapper.style.display = 'inline-block';
                            const urlEl2 = document.getElementById('qr-url');
                            if (urlEl2) { urlEl2.style.display = 'inline-block'; }
                            // Don't need to restart - same session can be reused
                            break;
                        case 'session_invalidated':
                            sasContainer.textContent = "🔄 Creating new secure session...";
                            statusElement.textContent = 'Session invalidated - creating new secure pairing session';
                            // Show QR code for new session
                            qrContainerWrapper.style.display = 'inline-block';
                            const urlEl3 = document.getElementById('qr-url');
                            if (urlEl3) { urlEl3.style.display = 'inline-block'; }
                            // Generate new session and restart
                            setTimeout(() => {
                                restartPairing();
                            }, 1000);
                            break;
                    }
                } catch (error) {
                    console.error('Failed to parse WebSocket message:', error);
                }
            };

            currentWs.onclose = () => {
                console.log('WebSocket disconnected');
                sasContainer.textContent = "Connection lost";
                statusElement.textContent = 'Connection lost - please reload page';
                currentWs = null;
            };
            
            currentWs.onerror = (error) => {
                console.error('WebSocket error:', error);
                sasContainer.textContent = "Connection error";
                statusElement.textContent = 'Connection error - please reload page';
            };
        }

        // Initialize the page
        async function initializePage() {
            await loadQRRefreshInterval();
            generateQR();
            connectWebSocket();
            startQRRefreshTimer();
        }
        
        // Start initialization
        initializePage();
    </script>
</body>
</html>
